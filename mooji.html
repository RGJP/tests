<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mooji Satsangs (1H+)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">

    <div class="container mx-auto px-4 py-8 md:py-12 max-w-3xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Mooji Satsangs</h1>
            <p class="mt-2 text-gray-600">All 1H+ videos from the official <a href="https://www.youtube.com/channel/UCpw2gh99XM6Mwsbksv0feEg" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">YouTube channel</a></p>
        </header>

        <main id="content">
            <div id="statusContainer" class="text-center text-gray-600 mb-4 space-y-2">
                <div id="statusMessage"></div>
                <div id="progressCounter" class="hidden">
                    <p>Found <span id="longVideoCount" class="font-bold text-blue-600">0</span> videos (1h+) so far...</p>
                </div>
            </div>
            <div id="videoList" class="space-y-6">
                </div>
        </main>

    </div>

    <script>
        // --- CONFIGURATION ---
        const API_KEY = 'AIzaSyCpCmU4Omt3WBPYw_pwoTPTj9vntgH_Sk4'; // Your unrestricted API key
        const CHANNEL_ID = 'UCpw2gh99XM6Mwsbksv0feEg';
        const UPLOADS_PLAYLIST_ID = CHANNEL_ID.replace(/^UC/, 'UU');
        const YOUTUBE_API_BASE_URL = 'https://www.googleapis.com/youtube/v3';

        // --- DOM ELEMENTS ---
        const videoListContainer = document.getElementById('videoList');
        const statusMessage = document.getElementById('statusMessage');
        const progressCounter = document.getElementById('progressCounter');
        const longVideoCountSpan = document.getElementById('longVideoCount');

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', loadVideos);

        /**
         * Initiates the video fetching and processing pipeline.
         */
        async function loadVideos() {
            videoListContainer.innerHTML = '';
            updateStatus('<div>Fetching video list...</div><div class="spinner mx-auto mt-4"></div>', false);

            try {
                const videoIds = await fetchAllVideoIds(API_KEY, UPLOADS_PLAYLIST_ID);

                if (videoIds.length === 0) {
                    updateStatus('No videos found on this channel.', false);
                    return;
                }

                updateStatus(`<div>Found ${videoIds.length} total videos. Now checking for 1h+ videos...</div><div class="spinner mx-auto mt-4"></div>`, false);
                progressCounter.classList.remove('hidden');
                longVideoCountSpan.textContent = '0';

                const longVideos = await fetchAndProcessVideoDetails(videoIds, API_KEY);
                longVideos.sort((a, b) => new Date(b.snippet.publishedAt) - new Date(a.snippet.publishedAt));

                updateStatus('', false);
                progressCounter.classList.add('hidden');
                displayVideos(longVideos);

            } catch (error) {
                console.error('Error fetching videos:', error);
                progressCounter.classList.add('hidden');
                let friendlyMessage = `Error: ${error.message}.`;
                if (error.message.includes('API key not valid')) {
                    friendlyMessage += ' Please check that the API key is valid and that its restrictions are configured correctly.';
                }
                updateStatus(friendlyMessage, true);
            }
        }

        /**
         * Fetches all video IDs from the channel's uploads playlist, handling API pagination.
         */
        async function fetchAllVideoIds(apiKey, playlistId) {
            let videoIds = [];
            let nextPageToken = '';
            updateStatus('<div>Fetching video list (this may take a moment)...</div><div class="spinner mx-auto mt-4"></div>', false);

            do {
                const url = `${YOUTUBE_API_BASE_URL}/playlistItems?key=${apiKey}&playlistId=${playlistId}&part=contentDetails&maxResults=50` + (nextPageToken ? `&pageToken=${nextPageToken}` : '');
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) throw new Error(data.error.message);

                const ids = data.items
                    .filter(item => item.contentDetails && item.contentDetails.videoId)
                    .map(item => item.contentDetails.videoId);
                videoIds = videoIds.concat(ids);
                nextPageToken = data.nextPageToken;

            } while (nextPageToken);
            return videoIds;
        }

        /**
         * Fetches video details in batches, filters for long videos, and updates the UI counter in real-time.
         */
        async function fetchAndProcessVideoDetails(videoIds, apiKey) {
            let longVideos = [];
            let longVideoCounter = 0;

            for (let i = 0; i < videoIds.length; i += 50) {
                const videoIdChunk = videoIds.slice(i, i + 50);
                const url = `${YOUTUBE_API_BASE_URL}/videos?key=${apiKey}&id=${videoIdChunk.join(',')}&part=snippet,contentDetails`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) throw new Error(data.error.message);

                for (const video of data.items) {
                    // **THIS IS THE CRITICAL FIX**
                    // This 'if' block checks that the necessary data exists before trying to use it.
                    if (video && video.contentDetails && video.contentDetails.duration) {
                        const durationInSeconds = parseISO8601Duration(video.contentDetails.duration);
                        if (durationInSeconds >= 3600) {
                            longVideos.push(video);
                            longVideoCounter++;
                            longVideoCountSpan.textContent = longVideoCounter;
                        }
                    }
                }
            }
            return longVideos;
        }

        /**
         * Renders the final list of videos to the DOM.
         */
        function displayVideos(videos) {
            if (videos.length === 0) {
                updateStatus('Found 0 videos with a duration of 1 hour or more.', false);
                return;
            }

            updateStatus(`Displaying ${videos.length} 1H+ videos, sorted by newest first.`, false);
            const videoElements = videos.map(video => {
                const videoUrl = `https://www.youtube.com/watch?v=${video.id}`;
                const title = video.snippet.title;
                const uploadDate = new Date(video.snippet.publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                const duration = formatISO8601Duration(video.contentDetails.duration);
                const thumbnailUrl = video.snippet.thumbnails.high.url;

                return `
                    <a href="${videoUrl}" target="_blank" rel="noopener noreferrer" class="block bg-white p-5 rounded-lg shadow-md hover:shadow-lg hover:scale-[1.02] transition-all duration-200 ease-in-out">
                        <div class="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-4">
                            <img src="${thumbnailUrl}" alt="Video Thumbnail" class="w-full md:w-48 h-auto rounded-md object-cover">
                            <div class="flex-grow">
                                <h3 class="text-lg font-semibold text-blue-700 hover:underline">${title}</h3>
                                <div class="flex justify-between items-center mt-2 text-sm text-gray-500">
                                    <span>Uploaded: ${uploadDate}</span>
                                    <span>Duration: ${duration}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `;
            }).join('');
            videoListContainer.innerHTML = videoElements;
        }

        /**
         * Parses an ISO 8601 duration string (e.g., "PT1H30M5S") into total seconds.
         */
        function parseISO8601Duration(duration) {
            // **THIS IS THE SECOND CRITICAL FIX**
            if (!duration) return 0;
            const regex = /PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/;
            const matches = duration.match(regex);
            
            if (!matches) return 0; // Return 0 if the format is unexpected

            const hours = parseInt(matches[1] || 0);
            const minutes = parseInt(matches[2] || 0);
            const seconds = parseInt(matches[3] || 0);
            return (hours * 3600) + (minutes * 60) + seconds;
        }

        /**
         * Formats an ISO 8601 duration string into a human-readable HH:MM:SS format.
         */
        function formatISO8601Duration(duration) {
            const totalSeconds = parseISO8601Duration(duration);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            if (hours > 0) {
                return `${hours}:${pad(minutes)}:${pad(seconds)}`;
            }
            return `${minutes}:${pad(seconds)}`;
        }

        /**
         * Updates the status message displayed to the user.
         */
        function updateStatus(message, isError) {
            statusMessage.innerHTML = message;
            statusMessage.className = `p-4 rounded-md ${isError ? 'text-red-700 bg-red-100' : 'text-gray-600'}`;
            statusMessage.parentElement.style.display = message ? 'block' : 'none';
        }
    </script>
</body>
</html>