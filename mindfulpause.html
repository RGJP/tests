<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mindfulness Pause v1.7</title>
  <style>
    #countdown-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(22, 45, 77, 0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

#countdown-number {
  font-size: 10rem;
  color: #ffd700;
  font-weight: bold;
  animation: pop 1s ease-in-out infinite;
}

@keyframes pop {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.3); opacity: 0.7; }
  100% { transform: scale(1); opacity: 1; }
}

    body {
      background-color: #162d4d;
      color: #ffd700;
      font-family: 'Arial', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    h1 {
      font-size: 3rem;
      margin-bottom: 2rem;
    }

    .button-container {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }

    button {
      background-color: rgba(255, 215, 0, 0.2);
      color: #ffd700;
      border: 2px solid #ffd700;
      padding: 12px 24px;
      font-size: 1.2rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    button:hover {
      background-color: rgba(255, 215, 0, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .progress-container {
      width: 80%;
      max-width: 400px;
      background-color: rgba(255, 215, 0, 0.2);
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
      display: none;
    }

    .progress-bar {
      height: 100%;
      background-color: #ffd700;
      width: 0%;
      transition: width 1s linear;
    }

    .timer {
      font-size: 2rem;
      margin-bottom: 20px;
      display: none;
    }

    .message {
      margin-top: 10px;
      font-size: 1.2rem;
      min-height: 50px;
    }

    .speaker-name {
      font-size: 1rem;
      font-style: none;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>üßò‚Äç‚ôÇÔ∏è Mindfulness Pause üßò</h1>

  <div class="button-container">
    <button id="five-min">5 Minutes</button>
    <button id="seven-min">7 Minutes</button>
    <button id="ten-min">10 Minutes</button>
  </div>

  <div id="duration-message" style="font-size: 1.5rem; margin-bottom: 10px;"></div>
  <div class="timer" id="timer">00:00</div>
  <div class="progress-container" id="progress-container">
    <div class="progress-bar" id="progress-bar"></div>
  </div>

  <br><br>
  <div class="speaker-name" id="speaker-name"></div>
  <div class="message" id="message"></div>

  <script>
window.addEventListener('DOMContentLoaded', () => {
  const userAgent = navigator.userAgent.toLowerCase();

  const isAndroid = () => {
    return userAgent.includes('android');
  };

  const isEdge = () => {
    return userAgent.includes('edg/') || userAgent.includes('edga') || userAgent.includes('edge');
  };

  if (isAndroid()) {
    alert('This WebApp does not currently support Android devices due to an unpatched bug in Edge on Android.');
  } else if (isEdge()) {
    console.log('OK - MS Edge detected');
  } else {
    alert('This WebApp only works in Microsoft Edge on desktop for improved voice quality. Please open this page in Microsoft Edge.');
  }
});


const fiveMinBtn = document.getElementById('five-min');
const tenMinBtn = document.getElementById('ten-min');
const timerDisplay = document.getElementById('timer');
const progressBar = document.getElementById('progress-bar');
const progressContainer = document.getElementById('progress-container');
const messageDisplay = document.getElementById('message');
const speakerNameDisplay = document.getElementById('speaker-name');

let meditation = null;
let totalDuration = 0;
let currentTime = 0;
let timerInterval = null;
let selectedVoice = null;

function loadVoices() {
  speechSynthesis.getVoices();
}

if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = loadVoices;
}

loadVoices();

function getRandom(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}


const scriptVariations = {
  0: [
    "Welcome. Let's begin. First, find a comfortable position and gently close your eyes.",
    "Welcome. Start by settling into a relaxed position. Softly close your eyes.",
    "Welcome. Begin by finding a comfortable position. Close your eyes gently and rest your hands.",
    "Welcome. Let's start by getting comfortable. Close your eyes and bring your focus inward.",
    "Welcome. Take a moment to get settled. Find stillness and softly let your eyes close.",
    "Welcome. Ease into stillness by finding a relaxed posture, and gently close your eyes.",
    "Welcome. Begin in a comfortable, restful position. Close your eyes and let your attention turn inward."
  ],
  30: [
    "Take a few deep breaths. In through your nose, and out through your mouth. Let your body settle on its own.",
    "Breathe deeply, inhale through the nose, exhale through the mouth. Let yourself arrive here, in this moment.",
    "Take deep breaths. Feel the air enter and leave. In through the nose, and out through the mouth.",
    "Inhale deeply... exhale fully, in through the nose, and out through the mouth. Allow each breath to settle your body and mind.",
    "Breathe in deeply... and breathe out fully through your mouth. Let your breath bring you to the Now.",
    "Draw in a full breath, and release it fully through your mouth. Let your body start to unwind.",
  ],
  60: [
    "Begin to notice how your body feels. Soften any tension in your face, your jaw, your shoulders, your hands. Releasing all tension from head to toe.",
    "Start scanning your body from head to toe. Relax your shoulders, your face, your hands. Let tension dissolve on its own.",
    "Tune into your physical body. Gently release any tightness in your jaw, your neck, your hands, in all areas of the body.",
    "Feel into your body. Allow each part to soften. Your face, your chest, your limbs, the whole body.",
    "Bring attention to your body. Loosen the areas that feel tight. Let go of tension.",
    "Gently check in with your body. Soften any tight areas. Let tension melt away.",
    "Let your body relax. Soften your face, your hands, your belly, your whole body. Let tension dissolve."
  ],
  90: [
    "Bring awareness to surrounding sounds and any sensations within. Notice your current mood and any emotions present. Let everything be as it is, like clouds in the sky.",
    "Listen to the sounds around you. Feel sensations as they come and go. Let your emotions be, without judgment.",
    "Observe the moment, sounds, feelings, thoughts, without clinging. Let everything drift by like clouds.",
    "Feel the world around and within you. Allow it all to flow without needing to change anything. Everything comes and goes, you simply observe.",
    "Notice what‚Äôs present, within and around you. Let it be, just as it is.",
    "Bring awareness to surrounding sounds and any sensations within. Notice your current mood and any emotions present. Let them rise and fall like waves.",
  ],
  120: [
  "..."
  ],
  180: [
    "Settle your attention on the breath. Notice its natural rhythm, rising with the inhale, falling with the exhale. Nothing else to do.",
    "Bring your focus to the breath. Feel it flow in and out, naturally. Nothing to do at all. Nothing to change.",
    "Notice the breath, how it moves in your body. Let it guide your awareness gently.",
    "Focus on the breath. Inhale, exhale, rise and fall. Let the natural rhythm soothe you into stillness.",
    "Feel your breath like a gentle wave. Riding it moment by moment. Rising and falling."
  ],
  240: [
    "Nothing to change, simply witnessing",
    "Just observing. Everything comes and goes, as it is.",
    "Be the simple observer. Let things be as they are.",
    "Resting in awareness, everything as it is, nothing to change.",
    "Simply witnessing, nothing to pursue, nothing to reject."
  ],
  270: [
    "As we begin to close, take a few deep breaths and exhale letting go of any remaining tension.",
    "as we begin to close, take some deep breaths. Inhale peace... exhale any remaining tension.",
    "As we near the end of the meditation, breathe in gently... and breathe out with ease.",
  ],
  290: [
    "Gently start to wiggle your fingers and toes. Bring movement back to the body.",
    "Begin to move your body slowly, wiggle your fingers, your toes, feel into the physical world.",
    "Awaken the body with gentle movements, stretch or shift softly.",
    "Introduce some small movements back to the body, gently rotate your wrists or ankles",
    "Let movement return naturally. Small shifts in your body, light stretches.",
    "Ease your way back with subtle motion. Stretch and move the body gently"
  ],
  295: [
    "When you're ready, slowly open your eyes. Carry this sense of stillness and calm with you. Let it guide your next steps.",
    "Slowly open your eyes when you feel ready. Bring this inner peace with you into your day.",
    "Open your eyes at your own pace, bringing a gentle awareness with you.",
    "When ready, let your eyes open gently. Keep that stillness within as you move forward.",
    "In your own time, let your eyes open slowly, soft and easy.",
    "Open your eyes when it feels right, returning with a sense of quiet clarity.",
    "Let the world come back into focus, eyes open, heart calm."
  ],
  300: [
    "Your mindfulness pause is complete. Wishing you a peaceful rest of your day. Until next time, goodbye.",
    "Your meditation is complete. Take this stillness with you, have a beautiful day ahead. Until next time, goodbye.",
    "You've completed a moment of mindful presence, well done. May the rest of your day unfold with ease. Until next time, goodbye.",
    "Your pause is complete. Carry this calm with you into whatever comes next. Be well. Until next time, goodbye.",
    "The meditation is complete, well done. Let the benefits of this pause ripple through your day. Until next time, goodbye.",
    "You‚Äôve taken a wonderful time for yourself. May your day continue with ease, balance and clarity. Until next time, goodbye."
  ]
};


function generateFiveMinuteMeditation() {
  return Object.entries(scriptVariations).map(([time, variations]) => ({
    time: Number(time),
    text: getRandom(variations)
  }));
}

const baseScriptSteps = Object.entries(scriptVariations).map(([time, variations]) => ({
  originalTime: Number(time),
  variations
}));

function generateStretchedSevenMinuteMeditation() {
      const totalDuration = 420;
      const numSteps = baseScriptSteps.length;
      const spacing = Math.floor(totalDuration / (numSteps - 1));

      return baseScriptSteps.map((step, index) => ({
        time: index * spacing,
        text: getRandom(step.variations)
      }));
    }

function generateStretchedTenMinuteMeditation() {
  const totalDuration = 600;
  const numSteps = baseScriptSteps.length;
  const spacing = Math.floor(totalDuration / (numSteps - 1));

  return baseScriptSteps.map((step, index) => ({
    time: index * spacing,
    text: getRandom(step.variations)
  }));
}

function speak(text) {
  return new Promise((resolve) => {
    speechSynthesis.cancel(); // üü° Add this line to cancel any ongoing speech

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 0.85;
    utterance.pitch = 0.5;

    if (selectedVoice) {
      utterance.voice = selectedVoice;
      speakerNameDisplay.textContent = `${selectedVoice.name}:`;
    } else {
      speakerNameDisplay.textContent = `Default Voice:`;
    }

    utterance.onend = resolve;
    speechSynthesis.speak(utterance);
  });
}

function formatTime(seconds) {
  const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
  const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
  return `${mins}:${secs}`;
}

async function processInstructions(meditationScript) {
  for (const instruction of meditationScript) {
    if (instruction.time === currentTime) {
      messageDisplay.textContent = instruction.text;
      await speak(instruction.text);

      if (instruction === meditationScript[meditationScript.length - 1]) {
        setTimeout(() => location.reload(), 2000);
      }
    }
  }
}


function showCountdownOverlay(startCallback) {
  const overlay = document.getElementById('countdown-overlay');
  const numberDisplay = document.getElementById('countdown-number');
  let count = 7;

  overlay.style.display = 'flex';
  numberDisplay.textContent = count;

  const countdown = setInterval(() => {
    count--;
    if (count > 0) {
      numberDisplay.textContent = count;
    } else {
      clearInterval(countdown);
      overlay.style.display = 'none';
      startCallback(); // üü¢ Start meditation after countdown
    }
  }, 1000);
}



function startMeditation(meditationScript, duration) {
  speechSynthesis.cancel();
  currentTime = 0;
  totalDuration = duration;
  meditation = meditationScript;

  const voices = speechSynthesis.getVoices();
  voices.forEach(voice => console.log(voice.name));   

  const enVoices = voices.filter(voice => voice.lang.toLowerCase().includes('en'));
  // enVoices.forEach(voice => console.log(voice.name));




  const preferredNames = ["Steffan","Christopher","Eric","Liam"]; // good voices are "Eric", "Steffan", "Jenny", "Liam","Thomas","Christopher"

const matchingVoices = enVoices.filter(voice =>
  preferredNames.some(name => {
    const regex = new RegExp(`\\b${name}\\b`, 'i'); // match whole word only
    return regex.test(voice.name);
  })
);

 // matchingVoices.forEach(voice => console.log(voice.name));


  selectedVoice = matchingVoices.length > 0
    ? matchingVoices[Math.floor(Math.random() * matchingVoices.length)]
    : null;

  timerDisplay.style.display = 'block';
  progressContainer.style.display = 'block';

  updateProgress();

  timerInterval = setInterval(() => {
    currentTime++;
    updateProgress();
    processInstructions(meditation);
  }, 1000);

  processInstructions(meditation);
}

function updateProgress() {
  timerDisplay.textContent = formatTime(currentTime);
  const progress = (currentTime / totalDuration) * 100;
  progressBar.style.width = `${progress}%`;
}

function resetMeditation() {
  if (timerInterval) clearInterval(timerInterval); // üü° Guard against multiple intervals
  timerInterval = null;

  speechSynthesis.cancel();
  messageDisplay.textContent = '';
  speakerNameDisplay.textContent = '';
  timerDisplay.textContent = '00:00';
  progressBar.style.width = '0%';
  currentTime = 0;
}


fiveMinBtn.addEventListener('click', () => {
  const freshScript = generateFiveMinuteMeditation();
  resetMeditation();
  document.getElementById('duration-message').textContent = "5 minutes meditation chosen";
  showCountdownOverlay(() => startMeditation(freshScript, 300));
});

sevenMinBtn.addEventListener('click', () => {
  const stretchedScript = generateStretchedSevenMinuteMeditation();
  resetMeditation();
  document.getElementById('duration-message').textContent = "7 minutes meditation chosen";
  showCountdownOverlay(() => startMeditation(stretchedScript, 420));
});

tenMinBtn.addEventListener('click', () => {
  const stretchedScript = generateStretchedTenMinuteMeditation();
  resetMeditation();
  document.getElementById('duration-message').textContent = "10 minutes meditation chosen";
  showCountdownOverlay(() => startMeditation(stretchedScript, 600));
});

  </script>

  <div id="countdown-overlay" style="display: none;">
    <div id="countdown-number">5</div>
  </div>
</body>
</html>