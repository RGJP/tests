<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>o4 Step Counter</title>
  <style>
    /* Full-screen center layout */
    body {
      margin: 0;
      padding: 0;
      background-color: #001f3f;       /* dark blue */
      color: #ffd700;                  /* gold */
      font-family: Arial, Helvetica, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      text-align: center;
    }
    #container {
      width: 90%;
      max-width: 400px;
    }
    h1, p {
      margin: 0.5em 0;
      font-size: 1.5em;
    }
    button {
      display: inline-block;
      width: 45%;
      margin: 1em 2.5%;
      padding: 0.75em 0;
      font-size: 1em;
      background-color: #ffd700;
      color: #001f3f;
      border: none;
      border-radius: 0.5em;
    }
    button:disabled {
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>Steps: <span id="stepCount">0</span></h1>
    <p>Distance (km): <span id="distanceKm">0.00</span></p>
    <p>Distance (miles): <span id="distanceMiles">0.00</span></p>
    <p>Calories burned: <span id="calories">0.00</span></p>
    <button id="startBtn">Start</button>
    <button id="resetBtn">Reset</button>
  </div>

  <script>
    (function() {
      let stepCount = 0;
      let lastStepTime = 0;
      const threshold = 1.2;          // acceleration threshold (m/sÂ²)
      const stepDelay = 300;          // minimum ms between steps
      const strideLength = 0.78;      // average stride in meters
      const caloriesPerStep = 0.04;   // average calories burned per step
      let listening = false;

      // DOM elements
      const stepElem = document.getElementById('stepCount');
      const kmElem   = document.getElementById('distanceKm');
      const miElem   = document.getElementById('distanceMiles');
      const calElem  = document.getElementById('calories');
      const startBtn = document.getElementById('startBtn');
      const resetBtn = document.getElementById('resetBtn');

      // Refresh on-screen values
      function updateDisplay() {
        stepElem.textContent = stepCount;
        const distMeters = stepCount * strideLength;
        const distKm = distMeters / 1000;
        kmElem.textContent = distKm.toFixed(2);
        miElem.textContent = (distKm * 0.621371).toFixed(2);
        calElem.textContent = (stepCount * caloriesPerStep).toFixed(2);
      }

      // Peak-detection step counter
      function handleMotion(event) {
        let ax, ay, az;
        if (event.acceleration && event.acceleration.x !== null) {
          ({ x: ax, y: ay, z: az } = event.acceleration);
        } else if (event.accelerationIncludingGravity) {
          ax = event.accelerationIncludingGravity.x;
          ay = event.accelerationIncludingGravity.y;
          // subtract gravity on approximate Z
          az = event.accelerationIncludingGravity.z - 9.81;
        } else {
          return; // no usable data
        }

        const magnitude = Math.sqrt(ax*ax + ay*ay + az*az);
        if (magnitude > threshold) {
          const now = Date.now();
          if (now - lastStepTime > stepDelay) {
            stepCount++;
            lastStepTime = now;
            updateDisplay();
          }
        }
      }

      // Begin listening (with iOS permission if needed)
      function startCounting() {
        if (listening) return;
        const enable = () => {
          window.addEventListener('devicemotion', handleMotion);
          listening = true;
          startBtn.disabled = true;
        };
        if (typeof DeviceMotionEvent !== 'undefined' &&
            typeof DeviceMotionEvent.requestPermission === 'function') {
          // iOS 13+ Safari
          DeviceMotionEvent.requestPermission()
            .then(response => {
              if (response === 'granted') enable();
              else alert('Motion permission was denied.');
            })
            .catch(err => console.error(err));
        } else {
          // Android / other
          enable();
        }
      }

      // Reset all counters
      function resetAll() {
        if (!confirm('Are you sure you want to reset all values?')) return;
        if (listening) {
          window.removeEventListener('devicemotion', handleMotion);
          listening = false;
        }
        stepCount = 0;
        lastStepTime = 0;
        updateDisplay();
        startBtn.disabled = false;
      }

      startBtn.addEventListener('click', startCounting);
      resetBtn.addEventListener('click', resetAll);
    })();
  </script>
</body>
</html>
