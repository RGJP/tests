<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Steps Counter</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0a1930;
            color: #ffd700;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            text-align: center;
            overflow: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px 0;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 30px;
        }

        .counter-display {
            font-size: 64px;
            font-weight: bold;
            margin-bottom: 40px;
            transition: all 0.3s;
        }

        .stats {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-item {
            background-color: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 15px;
            font-size: 18px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-top: 8px;
        }

        .permissions-message {
            padding: 15px;
            background-color: rgba(255, 215, 0, 0.15);
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .btn {
            background-color: #ffd700;
            color: #0a1930;
            border: none;
            border-radius: 8px;
            padding: 15px 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover, .btn:active {
            background-color: #ffeb3b;
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #0a1930;
            border: 2px solid #ffd700;
            border-radius: 12px;
            padding: 25px;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div>
            <h1>STEPS COUNTER</h1>
            <div id="stepsDisplay" class="counter-display">0</div>
            
            <div class="stats">
                <div class="stat-item">
                    <div>Distance (km)</div>
                    <div id="kmDisplay" class="stat-value">0.00</div>
                </div>
                <div class="stat-item">
                    <div>Distance (miles)</div>
                    <div id="milesDisplay" class="stat-value">0.00</div>
                </div>
                <div class="stat-item">
                    <div>Calories Burned</div>
                    <div id="caloriesDisplay" class="stat-value">0</div>
                </div>
            </div>
        </div>
        
        <div id="permissionsMessage" class="permissions-message">
            Please grant permission to track your steps
        </div>
        
        <div>
            <button id="resetBtn" class="btn">Reset Counter</button>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <p>Are you sure you want to reset all counters to zero?</p>
            <div class="modal-buttons">
                <button id="cancelReset" class="btn">Cancel</button>
                <button id="confirmReset" class="btn">Reset</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const stepsDisplay = document.getElementById('stepsDisplay');
            const kmDisplay = document.getElementById('kmDisplay');
            const milesDisplay = document.getElementById('milesDisplay');
            const caloriesDisplay = document.getElementById('caloriesDisplay');
            const resetBtn = document.getElementById('resetBtn');
            const confirmModal = document.getElementById('confirmModal');
            const cancelReset = document.getElementById('cancelReset');
            const confirmReset = document.getElementById('confirmReset');
            const permissionsMessage = document.getElementById('permissionsMessage');
            
            // Constants for calculations
            const STEP_LENGTH_METERS = 0.762; // Average step length (~30 inches)
            const CALORIES_PER_STEP = 0.04;   // Average calories burned per step
            
            // State variables
            let stepCount = 0;
            let hasPedometer = false;
            
            // Check for local storage data
            function loadStoredData() {
                const storedSteps = localStorage.getItem('stepCount');
                if (storedSteps !== null) {
                    stepCount = parseInt(storedSteps, 10);
                    updateDisplays();
                }
            }
            
            // Save data to local storage
            function saveData() {
                localStorage.setItem('stepCount', stepCount.toString());
            }
            
            // Update all display elements
            function updateDisplays() {
                stepsDisplay.textContent = stepCount.toLocaleString();
                
                const distanceKm = (stepCount * STEP_LENGTH_METERS / 1000).toFixed(2);
                const distanceMiles = (distanceKm * 0.621371).toFixed(2);
                const caloriesBurned = Math.round(stepCount * CALORIES_PER_STEP);
                
                kmDisplay.textContent = distanceKm;
                milesDisplay.textContent = distanceMiles;
                caloriesDisplay.textContent = caloriesBurned.toLocaleString();
            }
            
            // Reset all counters
            function resetCounters() {
                stepCount = 0;
                updateDisplays();
                saveData();
                confirmModal.style.display = 'none';
            }
            
            // Try to detect steps using the device's pedometer
            function initializeStepCounter() {
                // Check if the browser supports the Pedometer API (iOS)
                if (window.Pedometer) {
                    hasPedometer = true;
                    permissionsMessage.classList.add('hidden');
                    
                    window.Pedometer.startPedometerUpdates((pedometerData) => {
                        if (pedometerData && pedometerData.numberOfSteps > 0) {
                            stepCount += pedometerData.numberOfSteps;
                            updateDisplays();
                            saveData();
                        }
                    });
                } 
                // Check if the device has DeviceMotionEvent (Android/iOS fallback)
                else if (window.DeviceMotionEvent) {
                    try {
                        // Request permission for DeviceMotion (needed for iOS 13+)
                        if (typeof DeviceMotionEvent.requestPermission === 'function') {
                            DeviceMotionEvent.requestPermission()
                                .then(permissionState => {
                                    if (permissionState === 'granted') {
                                        initializeStepDetection();
                                    } else {
                                        showPermissionError();
                                    }
                                })
                                .catch(error => {
                                    console.error('Error requesting motion permission:', error);
                                    showPermissionError();
                                });
                        } else {
                            // For Android or iOS < 13
                            initializeStepDetection();
                        }
                    } catch (error) {
                        console.error('Error setting up motion detection:', error);
                        showPermissionError();
                    }
                } 
                // Use Sensor API if available (newer Chrome)
                else if ('LinearAccelerationSensor' in window) {
                    try {
                        const sensor = new LinearAccelerationSensor();
                        sensor.addEventListener('reading', () => {
                            detectStep(sensor.x, sensor.y, sensor.z);
                        });
                        sensor.start();
                        hasPedometer = true;
                        permissionsMessage.classList.add('hidden');
                    } catch (error) {
                        console.error('Error setting up acceleration sensor:', error);
                        showPermissionError();
                    }
                } else {
                    // No pedometer support
                    showPermissionError('Your device does not support step counting');
                }
            }
            
            // Variables for step detection algorithm
            let lastAcceleration = { x: 0, y: 0, z: 0 };
            let lastTimestamp = 0;
            let stepThreshold = 10; // Adjustable threshold for step detection
            let cooldownPeriod = 300; // Milliseconds between step counts to prevent duplicates
            
            function initializeStepDetection() {
                hasPedometer = true;
                permissionsMessage.classList.add('hidden');
                
                window.addEventListener('devicemotion', (event) => {
                    const acceleration = event.accelerationIncludingGravity;
                    if (!acceleration) return;
                    
                    const currentTime = new Date().getTime();
                    
                    // Calculate change in acceleration
                    const deltaX = Math.abs(acceleration.x - lastAcceleration.x);
                    const deltaY = Math.abs(acceleration.y - lastAcceleration.y);
                    const deltaZ = Math.abs(acceleration.z - lastAcceleration.z);
                    
                    // Update last values
                    lastAcceleration = {
                        x: acceleration.x,
                        y: acceleration.y,
                        z: acceleration.z
                    };
                    
                    // Detect if this movement is likely a step
                    const accelerationMagnitude = Math.sqrt(deltaX * deltaX + deltaY * deltaY + deltaZ * deltaZ);
                    
                    if (accelerationMagnitude > stepThreshold && (currentTime - lastTimestamp) > cooldownPeriod) {
                        stepCount++;
                        updateDisplays();
                        saveData();
                        lastTimestamp = currentTime;
                        
                        // Visual feedback
                        stepsDisplay.classList.add('pulse');
                        setTimeout(() => {
                            stepsDisplay.classList.remove('pulse');
                        }, 500);
                    }
                });
            }
            
            function detectStep(x, y, z) {
                const currentTime = new Date().getTime();
                
                // Calculate change in acceleration
                const deltaX = Math.abs(x - lastAcceleration.x);
                const deltaY = Math.abs(y - lastAcceleration.y);
                const deltaZ = Math.abs(z - lastAcceleration.z);
                
                // Update last values
                lastAcceleration = { x, y, z };
                
                // Detect if this movement is likely a step
                const accelerationMagnitude = Math.sqrt(deltaX * deltaX + deltaY * deltaY + deltaZ * deltaZ);
                
                if (accelerationMagnitude > stepThreshold && (currentTime - lastTimestamp) > cooldownPeriod) {
                    stepCount++;
                    updateDisplays();
                    saveData();
                    lastTimestamp = currentTime;
                    
                    // Visual feedback
                    stepsDisplay.classList.add('pulse');
                    setTimeout(() => {
                        stepsDisplay.classList.remove('pulse');
                    }, 500);
                }
            }
            
            function showPermissionError(message = 'Permission needed to track steps') {
                permissionsMessage.textContent = message;
                permissionsMessage.style.display = 'block';
                
                // Add a button to try again
                const retryButton = document.createElement('button');
                retryButton.textContent = 'Grant Permission';
                retryButton.className = 'btn';
                retryButton.style.marginTop = '10px';
                retryButton.style.fontSize = '16px';
                retryButton.addEventListener('click', initializeStepCounter);
                permissionsMessage.appendChild(retryButton);
            }
            
            // Event Listeners
            resetBtn.addEventListener('click', function() {
                confirmModal.style.display = 'flex';
            });
            
            cancelReset.addEventListener('click', function() {
                confirmModal.style.display = 'none';
            });
            
            confirmReset.addEventListener('click', resetCounters);
            
            // Initialize the app
            loadStoredData();
            initializeStepCounter();
            
            // Handle visibility changes to ensure counter continues when app is in background
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') {
                    // Reload data when returning to the page
                    loadStoredData();
                    
                    // Reinitialize step counter if needed
                    if (!hasPedometer) {
                        initializeStepCounter();
                    }
                }
            });
        });
    </script>
</body>
</html>